#!/bin/bash
#
# fake drain script
<%
  batlight= p('instance_groups').select{ |ig| ig['name'] == 'batlight' }
  batlight_props = batlight['properties']
  drain_type = batlight_props['drain_type']
  dynamic_drain_wait1 = batlight_props['dynamic_drain_wait1']
  dynamic_drain_wait2 = batlight_props['dynamic_drain_wait2']
%>
DRAIN_TYPE=<%= drain_type %>
DYNAMIC_DRAIN_WAIT1=<%= dynamic_drain_wait1 %>
DYNAMIC_DRAIN_WAIT2=<%= dynamic_drain_wait2 %>
FLAG=/tmp/drain

case $DRAIN_TYPE in

  static)
    if [ -f $FLAG ]; then
      echo "0"
    else
      touch $FLAG
      echo "2"
    fi
    ;;


  dynamic)
  # echo timestamp (in seconds) to FLAG. When deployment finishes, we ssh to get
  # the contents of FLAG and test if the difference between the 3 timestamps
  # equals dynamic_drain_wait1 and dynamic_drain_wait2.
    case $1 in

      job_changed)
        touch $FLAG
        echo $(date +%s) > $FLAG
        echo $DYNAMIC_DRAIN_WAIT1
        ;;

      job_check_status)
        echo $(date +%s) >> $FLAG
        lines=$(wc -l $FLAG | cut -f 1 -d ' ')
        if [ $lines -gt 2 ] ; then
          echo "0"
        else
          echo $DYNAMIC_DRAIN_WAIT2
        fi
        ;;

    esac
    ;;

esac
